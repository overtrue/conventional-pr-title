"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.OctokitGitHubService = void 0;
exports.createGitHubService = createGitHubService;
exports.getPRInfoFromContext = getPRInfoFromContext;
exports.detectLanguage = detectLanguage;
exports.detectLanguageFromPR = detectLanguageFromPR;
exports.formatCommentWithMention = formatCommentWithMention;
exports.withRetry = withRetry;
const github_1 = require("@actions/github");
const github_2 = require("@actions/github");
// Base English template - all other languages will translate from this
const BASE_TEMPLATE = {
    greeting: 'Hi @{author}! ðŸ‘‹',
    explanation: "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:",
    reasoningLabel: '**Reasoning:**',
    actionPrompt: 'Would you like me to update the title automatically, or would you prefer to update it yourself?',
    footer: '*This comment was generated by the Conventional PR Title Action*'
};
// Simple translation function using fallback translations
function translateText(text, targetLanguage) {
    var _a;
    if (targetLanguage === 'en')
        return text;
    // Simple translations for key phrases
    const translations = {
        en: {},
        zh: {
            'Hi @{author}! ðŸ‘‹': 'ä½ å¥½ @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'æˆ‘æ³¨æ„åˆ°æ‚¨çš„PRæ ‡é¢˜ä¸ç¬¦åˆ [Conventional Commits](https://www.conventionalcommits.org/) æ ‡å‡†ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®ï¼š',
            '**Reasoning:**': '**åŽŸå› ï¼š**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'æ‚¨å¸Œæœ›æˆ‘è‡ªåŠ¨æ›´æ–°æ ‡é¢˜ï¼Œè¿˜æ˜¯æ‚¨è‡ªå·±æ›´æ–°ï¼Ÿ',
            '*This comment was generated by the Conventional PR Title Action*': '*æ­¤è¯„è®ºç”± Conventional PR Title Action è‡ªåŠ¨ç”Ÿæˆ*'
        },
        ja: {
            'Hi @{author}! ðŸ‘‹': 'ã“ã‚“ã«ã¡ã¯ @{author}ã•ã‚“! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'PRã‚¿ã‚¤ãƒˆãƒ«ãŒ [Conventional Commits](https://www.conventionalcommits.org/) æ¨™æº–ã«å¾“ã£ã¦ã„ãªã„ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚ä»¥ä¸‹ãŒææ¡ˆã§ã™ï¼š',
            '**Reasoning:**': '**ç†ç”±ï¼š**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’è‡ªå‹•çš„ã«æ›´æ–°ã—ã¾ã™ã‹ã€ãã‚Œã¨ã‚‚ã”è‡ªèº«ã§æ›´æ–°ã•ã‚Œã¾ã™ã‹ï¼Ÿ',
            '*This comment was generated by the Conventional PR Title Action*': '*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ Conventional PR Title Action ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*'
        },
        ko: {
            'Hi @{author}! ðŸ‘‹': 'ì•ˆë…•í•˜ì„¸ìš” @{author}ë‹˜! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'PR ì œëª©ì´ [Conventional Commits](https://www.conventionalcommits.org/) í‘œì¤€ì„ ë”°ë¥´ì§€ ì•ŠëŠ” ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì€ ì œì•ˆì‚¬í•­ìž…ë‹ˆë‹¤:',
            '**Reasoning:**': '**ì´ìœ :**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'ì œëª©ì„ ìžë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í• ê¹Œìš”, ì•„ë‹ˆë©´ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            '*This comment was generated by the Conventional PR Title Action*': '*ì´ ëŒ“ê¸€ì€ Conventional PR Title Actionì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤*'
        },
        es: {
            'Hi @{author}! ðŸ‘‹': 'Â¡Hola @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'He notado que el tÃ­tulo de tu PR no sigue el estÃ¡ndar de [Conventional Commits](https://www.conventionalcommits.org/). AquÃ­ tienes algunas sugerencias:',
            '**Reasoning:**': '**RazÃ³n:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Â¿Te gustarÃ­a que actualice el tÃ­tulo automÃ¡ticamente, o prefieres actualizarlo tÃº mismo?',
            '*This comment was generated by the Conventional PR Title Action*': '*Este comentario fue generado por Conventional PR Title Action*'
        },
        fr: {
            'Hi @{author}! ðŸ‘‹': 'Salut @{author} ! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": "J'ai remarquÃ© que le titre de votre PR ne suit pas le standard [Conventional Commits](https://www.conventionalcommits.org/). Voici quelques suggestions :",
            '**Reasoning:**': '**Raison :**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Souhaitez-vous que je mette Ã  jour le titre automatiquement, ou prÃ©fÃ©rez-vous le mettre Ã  jour vous-mÃªme ?',
            '*This comment was generated by the Conventional PR Title Action*': '*Ce commentaire a Ã©tÃ© gÃ©nÃ©rÃ© par Conventional PR Title Action*'
        },
        de: {
            'Hi @{author}! ðŸ‘‹': 'Hallo @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Mir ist aufgefallen, dass dein PR-Titel nicht dem [Conventional Commits](https://www.conventionalcommits.org/) Standard folgt. Hier sind einige VorschlÃ¤ge:',
            '**Reasoning:**': '**Grund:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'MÃ¶chtest du, dass ich den Titel automatisch aktualisiere, oder wÃ¼rdest du ihn lieber selbst aktualisieren?',
            '*This comment was generated by the Conventional PR Title Action*': '*Dieser Kommentar wurde von Conventional PR Title Action generiert*'
        },
        pt: {
            'Hi @{author}! ðŸ‘‹': 'OlÃ¡ @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Notei que o tÃ­tulo do seu PR nÃ£o segue o padrÃ£o [Conventional Commits](https://www.conventionalcommits.org/). Aqui estÃ£o algumas sugerÃªncias:',
            '**Reasoning:**': '**Motivo:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Gostaria que eu atualizasse o tÃ­tulo automaticamente, ou prefere atualizar vocÃª mesmo?',
            '*This comment was generated by the Conventional PR Title Action*': '*Este comentÃ¡rio foi gerado pelo Conventional PR Title Action*'
        },
        ru: {
            'Hi @{author}! ðŸ‘‹': 'ÐŸÑ€Ð¸Ð²ÐµÑ‚ @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ð¯ Ð·Ð°Ð¼ÐµÑ‚Ð¸Ð», Ñ‡Ñ‚Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð²Ð°ÑˆÐµÐ³Ð¾ PR Ð½Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ñƒ [Conventional Commits](https://www.conventionalcommits.org/). Ð’Ð¾Ñ‚ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹:',
            '**Reasoning:**': '**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð» Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº, Ð¸Ð»Ð¸ Ð²Ñ‹ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ ÑÐ°Ð¼Ð¸?',
            '*This comment was generated by the Conventional PR Title Action*': '*Ð­Ñ‚Ð¾Ñ‚ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Conventional PR Title Action*'
        },
        it: {
            'Hi @{author}! ðŸ‘‹': 'Ciao @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ho notato che il titolo del tuo PR non segue lo standard [Conventional Commits](https://www.conventionalcommits.org/). Ecco alcuni suggerimenti:',
            '**Reasoning:**': '**Motivo:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Vorresti che aggiorni il titolo automaticamente, o preferisci aggiornarlo tu stesso?',
            '*This comment was generated by the Conventional PR Title Action*': '*Questo commento Ã¨ stato generato da Conventional PR Title Action*'
        },
        nl: {
            'Hi @{author}! ðŸ‘‹': 'Hoi @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ik heb gemerkt dat je PR-titel niet voldoet aan de [Conventional Commits](https://www.conventionalcommits.org/) standaard. Hier zijn enkele suggesties:',
            '**Reasoning:**': '**Reden:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Wil je dat ik de titel automatisch bijwerk, of werk je hem liever zelf bij?',
            '*This comment was generated by the Conventional PR Title Action*': '*Dit commentaar is gegenereerd door Conventional PR Title Action*'
        },
        ar: {
            'Hi @{author}! ðŸ‘‹': 'Ù…Ø±Ø­Ø¨Ø§ @{author}! ðŸ‘‹',
            "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ù„Ø§Ø­Ø¸Øª Ø£Ù† Ø¹Ù†ÙˆØ§Ù† Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø§ ÙŠØªØ¨Ø¹ Ù…Ø¹ÙŠØ§Ø± [Conventional Commits](https://www.conventionalcommits.org/). Ø¥Ù„ÙŠÙƒ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª:',
            '**Reasoning:**': '**Ø§Ù„Ø³Ø¨Ø¨:**',
            'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø£Ù… ØªÙØ¶Ù„ ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ù†ÙØ³ÙƒØŸ',
            '*This comment was generated by the Conventional PR Title Action*': '*ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© Conventional PR Title Action*'
        }
    };
    return ((_a = translations[targetLanguage]) === null || _a === void 0 ? void 0 : _a[text]) || text;
}
// Get translated template for a language
function getLocalizedTemplate(language) {
    return {
        greeting: translateText(BASE_TEMPLATE.greeting, language),
        explanation: translateText(BASE_TEMPLATE.explanation, language),
        reasoningLabel: translateText(BASE_TEMPLATE.reasoningLabel, language),
        actionPrompt: translateText(BASE_TEMPLATE.actionPrompt, language),
        footer: translateText(BASE_TEMPLATE.footer, language)
    };
}
class OctokitGitHubService {
    constructor(config) {
        this.octokit = (0, github_1.getOctokit)(config.token);
        // Use provided owner/repo or get from context
        this.owner = config.owner !== undefined ? config.owner : github_2.context.repo.owner;
        this.repo = config.repo !== undefined ? config.repo : github_2.context.repo.repo;
        if (!this.owner || !this.repo || this.owner === '' || this.repo === '') {
            throw new Error('GitHub repository owner and name must be provided or available in context');
        }
    }
    async getPRInfo(prNumber) {
        var _a;
        try {
            const { data: pr } = await this.octokit.rest.pulls.get({
                owner: this.owner,
                repo: this.repo,
                pull_number: prNumber
            });
            return {
                number: pr.number,
                title: pr.title,
                body: pr.body,
                author: ((_a = pr.user) === null || _a === void 0 ? void 0 : _a.login) || 'unknown',
                headRef: pr.head.ref,
                baseRef: pr.base.ref,
                labels: pr.labels.map(label => typeof label === 'string' ? label : label.name || ''),
                isDraft: pr.draft || false
            };
        }
        catch (error) {
            throw new Error(`Failed to get PR info: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    async updatePRTitle(prNumber, newTitle) {
        try {
            await this.octokit.rest.pulls.update({
                owner: this.owner,
                repo: this.repo,
                pull_number: prNumber,
                title: newTitle
            });
        }
        catch (error) {
            throw new Error(`Failed to update PR title: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    async createComment(prNumber, body) {
        var _a;
        try {
            const { data: comment } = await this.octokit.rest.issues.createComment({
                owner: this.owner,
                repo: this.repo,
                issue_number: prNumber,
                body
            });
            return {
                id: comment.id,
                body: comment.body || '',
                author: ((_a = comment.user) === null || _a === void 0 ? void 0 : _a.login) || 'unknown',
                createdAt: comment.created_at
            };
        }
        catch (error) {
            throw new Error(`Failed to create comment: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    async getChangedFiles(prNumber) {
        try {
            const { data: files } = await this.octokit.rest.pulls.listFiles({
                owner: this.owner,
                repo: this.repo,
                pull_number: prNumber
            });
            return files.map(file => file.filename);
        }
        catch (error) {
            throw new Error(`Failed to get changed files: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    async checkPermissions() {
        try {
            // Try to get repository info to check read permissions
            await this.octokit.rest.repos.get({
                owner: this.owner,
                repo: this.repo
            });
            // Try to check if we have write permissions by getting the current user's permission level
            const { data: permission } = await this.octokit.rest.repos.getCollaboratorPermissionLevel({
                owner: this.owner,
                repo: this.repo,
                username: await this.getCurrentUser()
            });
            return ['admin', 'write'].includes(permission.permission);
        }
        catch (error) {
            console.warn('Permission check failed:', error);
            return false;
        }
    }
    async getCurrentUser() {
        try {
            const { data: user } = await this.octokit.rest.users.getAuthenticated();
            return user.login;
        }
        catch (error) {
            throw new Error(`Failed to get current user: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
}
exports.OctokitGitHubService = OctokitGitHubService;
// Utility functions for common operations
async function createGitHubService(token) {
    const githubToken = token || process.env.GITHUB_TOKEN;
    if (!githubToken) {
        throw new Error('GitHub token is required. Set GITHUB_TOKEN environment variable or provide token parameter.');
    }
    return new OctokitGitHubService({ token: githubToken });
}
async function getPRInfoFromContext() {
    var _a;
    if (github_2.context.eventName !== 'pull_request' &&
        github_2.context.eventName !== 'pull_request_target') {
        return null;
    }
    const prNumber = (_a = github_2.context.payload.pull_request) === null || _a === void 0 ? void 0 : _a.number;
    if (!prNumber) {
        return null;
    }
    const service = await createGitHubService();
    return service.getPRInfo(prNumber);
}
// Language detection utility functions
function detectLanguage(text) {
    const cleanText = text.toLowerCase();
    // Chinese detection
    if (/[\u4e00-\u9fff]/.test(text)) {
        return 'zh';
    }
    // Japanese detection (Hiragana, Katakana, Kanji)
    if (/[\u3040-\u309f\u30a0-\u30ff\u4e00-\u9fff]/.test(text) && /[\u3040-\u309f\u30a0-\u30ff]/.test(text)) {
        return 'ja';
    }
    // Korean detection
    if (/[\uac00-\ud7af\u1100-\u11ff\u3130-\u318f]/.test(text)) {
        return 'ko';
    }
    // Spanish keywords detection
    if (/\b(espaÃ±ol|cambios?|aÃ±adir|agregar|corregir|actualizar|mejorar)\b/.test(cleanText)) {
        return 'es';
    }
    // French keywords detection  
    if (/\b(franÃ§ais|ajouter|corriger|mettre Ã  jour|amÃ©liorer|modification)\b/.test(cleanText)) {
        return 'fr';
    }
    // German keywords detection
    if (/\b(deutsch|hinzufÃ¼gen|korrigieren|aktualisieren|verbessern|Ã¤nderung)\b/.test(cleanText)) {
        return 'de';
    }
    // Portuguese keywords detection
    if (/\b(portuguÃªs|adicionar|corrigir|atualizar|melhorar|alteraÃ§Ã£o)\b/.test(cleanText)) {
        return 'pt';
    }
    // Russian keywords detection
    if (/\b(Ñ€ÑƒÑÑÐºÐ¸Ð¹|Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ|Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ|Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ|ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ|Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ)\b/.test(cleanText) || /[Ð°-ÑÑ‘]/i.test(text)) {
        return 'ru';
    }
    // Italian keywords detection
    if (/\b(italiano|aggiungere|correggere|aggiornare|migliorare|modifica)\b/.test(cleanText)) {
        return 'it';
    }
    // Dutch keywords detection
    if (/\b(nederlands|toevoegen|corrigeren|bijwerken|verbeteren|wijziging)\b/.test(cleanText)) {
        return 'nl';
    }
    // Arabic detection
    if (/[\u0600-\u06ff]/.test(text)) {
        return 'ar';
    }
    // Default to English
    return 'en';
}
function detectLanguageFromPR(prInfo) {
    const textToAnalyze = [
        prInfo.title,
        prInfo.body || '',
    ].join(' ');
    return detectLanguage(textToAnalyze);
}
// Utility function to format comment body with mentions and language support
function formatCommentWithMention(author, suggestions, reasoning, language, prInfo) {
    // Auto-detect language if not provided
    const detectedLanguage = language || (prInfo ? detectLanguageFromPR(prInfo) : 'en');
    const template = getLocalizedTemplate(detectedLanguage);
    const suggestionsList = suggestions
        .map((suggestion, index) => `${index + 1}. \`${suggestion}\``)
        .join('\n');
    return `${template.greeting.replace('{author}', author)}

${template.explanation}

${suggestionsList}

${template.reasoningLabel} ${reasoning}

${template.actionPrompt}

---
${template.footer}`;
}
// Retry wrapper for GitHub API calls
async function withRetry(operation, maxRetries = 3, delayMs = 1000) {
    let lastError;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            return await operation();
        }
        catch (error) {
            lastError = error instanceof Error ? error : new Error(String(error));
            // Don't retry on authentication or permission errors
            if (lastError.message.includes('401') ||
                lastError.message.includes('403')) {
                throw lastError;
            }
            if (attempt === maxRetries) {
                throw new Error(`Operation failed after ${maxRetries} attempts: ${lastError.message}`);
            }
            // Exponential backoff
            await new Promise(resolve => setTimeout(resolve, delayMs * Math.pow(2, attempt - 1)));
        }
    }
    throw lastError;
}
//# sourceMappingURL=github-service.js.map