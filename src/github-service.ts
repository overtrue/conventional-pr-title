import { getOctokit } from '@actions/github'
import { context } from '@actions/github'

export type SupportedLanguage = 'en' | 'zh' | 'ja' | 'ko' | 'es' | 'fr' | 'de' | 'pt' | 'ru' | 'it' | 'nl' | 'ar'

export interface CommentTemplate {
  greeting: string
  explanation: string
  reasoningLabel: string
  actionPrompt: string
  footer: string
}

// Base English template - all other languages will translate from this
const BASE_TEMPLATE: CommentTemplate = {
  greeting: 'Hi @{author}! ğŸ‘‹',
  explanation: "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:",
  reasoningLabel: '**Reasoning:**',
  actionPrompt: 'Would you like me to update the title automatically, or would you prefer to update it yourself?',
  footer: '*This comment was generated by the Conventional PR Title Action*'
}

// Simple translation function using fallback translations
function translateText(text: string, targetLanguage: SupportedLanguage): string {
  if (targetLanguage === 'en') return text
  
  // Simple translations for key phrases
  const translations: Record<SupportedLanguage, Record<string, string>> = {
    en: {},
    zh: {
      'Hi @{author}! ğŸ‘‹': 'ä½ å¥½ @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'æˆ‘æ³¨æ„åˆ°æ‚¨çš„PRæ ‡é¢˜ä¸ç¬¦åˆ [Conventional Commits](https://www.conventionalcommits.org/) æ ‡å‡†ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®ï¼š',
      '**Reasoning:**': '**åŸå› ï¼š**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'æ‚¨å¸Œæœ›æˆ‘è‡ªåŠ¨æ›´æ–°æ ‡é¢˜ï¼Œè¿˜æ˜¯æ‚¨è‡ªå·±æ›´æ–°ï¼Ÿ',
      '*This comment was generated by the Conventional PR Title Action*': '*æ­¤è¯„è®ºç”± Conventional PR Title Action è‡ªåŠ¨ç”Ÿæˆ*'
    },
    ja: {
      'Hi @{author}! ğŸ‘‹': 'ã“ã‚“ã«ã¡ã¯ @{author}ã•ã‚“! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'PRã‚¿ã‚¤ãƒˆãƒ«ãŒ [Conventional Commits](https://www.conventionalcommits.org/) æ¨™æº–ã«å¾“ã£ã¦ã„ãªã„ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚ä»¥ä¸‹ãŒææ¡ˆã§ã™ï¼š',
      '**Reasoning:**': '**ç†ç”±ï¼š**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’è‡ªå‹•çš„ã«æ›´æ–°ã—ã¾ã™ã‹ã€ãã‚Œã¨ã‚‚ã”è‡ªèº«ã§æ›´æ–°ã•ã‚Œã¾ã™ã‹ï¼Ÿ',
      '*This comment was generated by the Conventional PR Title Action*': '*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ Conventional PR Title Action ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*'
    },
    ko: {
      'Hi @{author}! ğŸ‘‹': 'ì•ˆë…•í•˜ì„¸ìš” @{author}ë‹˜! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'PR ì œëª©ì´ [Conventional Commits](https://www.conventionalcommits.org/) í‘œì¤€ì„ ë”°ë¥´ì§€ ì•ŠëŠ” ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì€ ì œì•ˆì‚¬í•­ì…ë‹ˆë‹¤:',
      '**Reasoning:**': '**ì´ìœ :**', 
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'ì œëª©ì„ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í• ê¹Œìš”, ì•„ë‹ˆë©´ ì§ì ‘ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      '*This comment was generated by the Conventional PR Title Action*': '*ì´ ëŒ“ê¸€ì€ Conventional PR Title Actionì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤*'
    },
    es: {
      'Hi @{author}! ğŸ‘‹': 'Â¡Hola @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'He notado que el tÃ­tulo de tu PR no sigue el estÃ¡ndar de [Conventional Commits](https://www.conventionalcommits.org/). AquÃ­ tienes algunas sugerencias:',
      '**Reasoning:**': '**RazÃ³n:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Â¿Te gustarÃ­a que actualice el tÃ­tulo automÃ¡ticamente, o prefieres actualizarlo tÃº mismo?',
      '*This comment was generated by the Conventional PR Title Action*': '*Este comentario fue generado por Conventional PR Title Action*'
    },
    fr: {
      'Hi @{author}! ğŸ‘‹': 'Salut @{author} ! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": "J'ai remarquÃ© que le titre de votre PR ne suit pas le standard [Conventional Commits](https://www.conventionalcommits.org/). Voici quelques suggestions :",
      '**Reasoning:**': '**Raison :**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Souhaitez-vous que je mette Ã  jour le titre automatiquement, ou prÃ©fÃ©rez-vous le mettre Ã  jour vous-mÃªme ?',
      '*This comment was generated by the Conventional PR Title Action*': '*Ce commentaire a Ã©tÃ© gÃ©nÃ©rÃ© par Conventional PR Title Action*'
    },
    de: {
      'Hi @{author}! ğŸ‘‹': 'Hallo @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Mir ist aufgefallen, dass dein PR-Titel nicht dem [Conventional Commits](https://www.conventionalcommits.org/) Standard folgt. Hier sind einige VorschlÃ¤ge:',
      '**Reasoning:**': '**Grund:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'MÃ¶chtest du, dass ich den Titel automatisch aktualisiere, oder wÃ¼rdest du ihn lieber selbst aktualisieren?',
      '*This comment was generated by the Conventional PR Title Action*': '*Dieser Kommentar wurde von Conventional PR Title Action generiert*'
    },
    pt: {
      'Hi @{author}! ğŸ‘‹': 'OlÃ¡ @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Notei que o tÃ­tulo do seu PR nÃ£o segue o padrÃ£o [Conventional Commits](https://www.conventionalcommits.org/). Aqui estÃ£o algumas sugerÃªncias:',
      '**Reasoning:**': '**Motivo:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Gostaria que eu atualizasse o tÃ­tulo automaticamente, ou prefere atualizar vocÃª mesmo?',
      '*This comment was generated by the Conventional PR Title Action*': '*Este comentÃ¡rio foi gerado pelo Conventional PR Title Action*'
    },
    ru: {
      'Hi @{author}! ğŸ‘‹': 'ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ğ¯ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ», Ñ‡Ñ‚Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ PR Ğ½Ğµ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ñƒ [Conventional Commits](https://www.conventionalcommits.org/). Ğ’Ğ¾Ñ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹:',
      '**Reasoning:**': '**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ» Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº, Ğ¸Ğ»Ğ¸ Ğ²Ñ‹ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞµĞ³Ğ¾ ÑĞ°Ğ¼Ğ¸?',
      '*This comment was generated by the Conventional PR Title Action*': '*Ğ­Ñ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ñ‹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Conventional PR Title Action*'
    },
    it: {
      'Hi @{author}! ğŸ‘‹': 'Ciao @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ho notato che il titolo del tuo PR non segue lo standard [Conventional Commits](https://www.conventionalcommits.org/). Ecco alcuni suggerimenti:',
      '**Reasoning:**': '**Motivo:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Vorresti che aggiorni il titolo automaticamente, o preferisci aggiornarlo tu stesso?',
      '*This comment was generated by the Conventional PR Title Action*': '*Questo commento Ã¨ stato generato da Conventional PR Title Action*'
    },
    nl: {
      'Hi @{author}! ğŸ‘‹': 'Hoi @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ik heb gemerkt dat je PR-titel niet voldoet aan de [Conventional Commits](https://www.conventionalcommits.org/) standaard. Hier zijn enkele suggesties:',
      '**Reasoning:**': '**Reden:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Wil je dat ik de titel automatisch bijwerk, of werk je hem liever zelf bij?',
      '*This comment was generated by the Conventional PR Title Action*': '*Dit commentaar is gegenereerd door Conventional PR Title Action*'
    },
    ar: {
      'Hi @{author}! ğŸ‘‹': 'Ù…Ø±Ø­Ø¨Ø§ @{author}! ğŸ‘‹',
      "I noticed your PR title doesn't follow the [Conventional Commits](https://www.conventionalcommits.org/) standard. Here are some suggestions:": 'Ù„Ø§Ø­Ø¸Øª Ø£Ù† Ø¹Ù†ÙˆØ§Ù† Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø§ ÙŠØªØ¨Ø¹ Ù…Ø¹ÙŠØ§Ø± [Conventional Commits](https://www.conventionalcommits.org/). Ø¥Ù„ÙŠÙƒ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª:',
      '**Reasoning:**': '**Ø§Ù„Ø³Ø¨Ø¨:**',
      'Would you like me to update the title automatically, or would you prefer to update it yourself?': 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø£Ù… ØªÙØ¶Ù„ ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ù†ÙØ³ÙƒØŸ',
      '*This comment was generated by the Conventional PR Title Action*': '*ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© Conventional PR Title Action*'
    }
  }
  
  return translations[targetLanguage]?.[text] || text
}

// Get translated template for a language
function getLocalizedTemplate(language: SupportedLanguage): CommentTemplate {
  return {
    greeting: translateText(BASE_TEMPLATE.greeting, language),
    explanation: translateText(BASE_TEMPLATE.explanation, language),
    reasoningLabel: translateText(BASE_TEMPLATE.reasoningLabel, language),
    actionPrompt: translateText(BASE_TEMPLATE.actionPrompt, language),
    footer: translateText(BASE_TEMPLATE.footer, language)
  }
}

export interface GitHubConfig {
  token: string
  owner?: string
  repo?: string
}

export interface PRInfo {
  number: number
  title: string
  body: string | null
  author: string
  headRef: string
  baseRef: string
  changedFiles?: string[]
  labels: string[]
  isDraft: boolean
}

export interface PRComment {
  id: number
  body: string
  author: string
  createdAt: string
}

export interface GitHubService {
  getPRInfo(prNumber: number): Promise<PRInfo>
  updatePRTitle(prNumber: number, newTitle: string): Promise<void>
  createComment(prNumber: number, body: string): Promise<PRComment>
  getChangedFiles(prNumber: number): Promise<string[]>
  checkPermissions(): Promise<boolean>
}

export class OctokitGitHubService implements GitHubService {
  private octokit: ReturnType<typeof getOctokit>
  private owner: string
  private repo: string

  constructor(config: GitHubConfig) {
    this.octokit = getOctokit(config.token)

    // Use provided owner/repo or get from context
    this.owner = config.owner !== undefined ? config.owner : context.repo.owner
    this.repo = config.repo !== undefined ? config.repo : context.repo.repo

    if (!this.owner || !this.repo || this.owner === '' || this.repo === '') {
      throw new Error(
        'GitHub repository owner and name must be provided or available in context'
      )
    }
  }

  async getPRInfo(prNumber: number): Promise<PRInfo> {
    try {
      const { data: pr } = await this.octokit.rest.pulls.get({
        owner: this.owner,
        repo: this.repo,
        pull_number: prNumber
      })

      return {
        number: pr.number,
        title: pr.title,
        body: pr.body,
        author: pr.user?.login || 'unknown',
        headRef: pr.head.ref,
        baseRef: pr.base.ref,
        labels: pr.labels.map(label =>
          typeof label === 'string' ? label : label.name || ''
        ),
        isDraft: pr.draft || false
      }
    } catch (error) {
      throw new Error(
        `Failed to get PR info: ${error instanceof Error ? error.message : 'Unknown error'}`
      )
    }
  }

  async updatePRTitle(prNumber: number, newTitle: string): Promise<void> {
    try {
      await this.octokit.rest.pulls.update({
        owner: this.owner,
        repo: this.repo,
        pull_number: prNumber,
        title: newTitle
      })
    } catch (error) {
      throw new Error(
        `Failed to update PR title: ${error instanceof Error ? error.message : 'Unknown error'}`
      )
    }
  }

  async createComment(prNumber: number, body: string): Promise<PRComment> {
    try {
      const { data: comment } = await this.octokit.rest.issues.createComment({
        owner: this.owner,
        repo: this.repo,
        issue_number: prNumber,
        body
      })

      return {
        id: comment.id,
        body: comment.body || '',
        author: comment.user?.login || 'unknown',
        createdAt: comment.created_at
      }
    } catch (error) {
      throw new Error(
        `Failed to create comment: ${error instanceof Error ? error.message : 'Unknown error'}`
      )
    }
  }

  async getChangedFiles(prNumber: number): Promise<string[]> {
    try {
      const { data: files } = await this.octokit.rest.pulls.listFiles({
        owner: this.owner,
        repo: this.repo,
        pull_number: prNumber
      })

      return files.map(file => file.filename)
    } catch (error) {
      throw new Error(
        `Failed to get changed files: ${error instanceof Error ? error.message : 'Unknown error'}`
      )
    }
  }

  async checkPermissions(): Promise<boolean> {
    try {
      // Try to get repository info to check read permissions
      await this.octokit.rest.repos.get({
        owner: this.owner,
        repo: this.repo
      })

      // Try to check if we have write permissions by getting the current user's permission level
      const { data: permission } =
        await this.octokit.rest.repos.getCollaboratorPermissionLevel({
          owner: this.owner,
          repo: this.repo,
          username: await this.getCurrentUser()
        })

      return ['admin', 'write'].includes(permission.permission)
    } catch (error) {
      console.warn('Permission check failed:', error)
      return false
    }
  }

  private async getCurrentUser(): Promise<string> {
    try {
      const { data: user } = await this.octokit.rest.users.getAuthenticated()
      return user.login
    } catch (error) {
      throw new Error(
        `Failed to get current user: ${error instanceof Error ? error.message : 'Unknown error'}`
      )
    }
  }
}

// Utility functions for common operations
export async function createGitHubService(
  token?: string
): Promise<GitHubService> {
  const githubToken = token || process.env.GITHUB_TOKEN

  if (!githubToken) {
    throw new Error(
      'GitHub token is required. Set GITHUB_TOKEN environment variable or provide token parameter.'
    )
  }

  return new OctokitGitHubService({ token: githubToken })
}

export async function getPRInfoFromContext(): Promise<PRInfo | null> {
  if (
    context.eventName !== 'pull_request' &&
    context.eventName !== 'pull_request_target'
  ) {
    return null
  }

  const prNumber = context.payload.pull_request?.number
  if (!prNumber) {
    return null
  }

  const service = await createGitHubService()
  return service.getPRInfo(prNumber)
}

// Language detection utility functions
export function detectLanguage(text: string): SupportedLanguage {
  const cleanText = text.toLowerCase()
  
  // Chinese detection
  if (/[\u4e00-\u9fff]/.test(text)) {
    return 'zh'
  }
  
  // Japanese detection (Hiragana, Katakana, Kanji)
  if (/[\u3040-\u309f\u30a0-\u30ff\u4e00-\u9fff]/.test(text) && /[\u3040-\u309f\u30a0-\u30ff]/.test(text)) {
    return 'ja'
  }
  
  // Korean detection
  if (/[\uac00-\ud7af\u1100-\u11ff\u3130-\u318f]/.test(text)) {
    return 'ko'
  }
  
  // Spanish keywords detection
  if (/\b(espaÃ±ol|cambios?|aÃ±adir|agregar|corregir|actualizar|mejorar)\b/.test(cleanText)) {
    return 'es'
  }
  
  // French keywords detection  
  if (/\b(franÃ§ais|ajouter|corriger|mettre Ã  jour|amÃ©liorer|modification)\b/.test(cleanText)) {
    return 'fr'
  }
  
  // German keywords detection
  if (/\b(deutsch|hinzufÃ¼gen|korrigieren|aktualisieren|verbessern|Ã¤nderung)\b/.test(cleanText)) {
    return 'de'
  }
  
  // Portuguese keywords detection
  if (/\b(portuguÃªs|adicionar|corrigir|atualizar|melhorar|alteraÃ§Ã£o)\b/.test(cleanText)) {
    return 'pt'
  }
  
  // Russian keywords detection
  if (/\b(Ñ€ÑƒÑÑĞºĞ¸Ğ¹|Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ|Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ|Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ|ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ|Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ)\b/.test(cleanText) || /[Ğ°-ÑÑ‘]/i.test(text)) {
    return 'ru'
  }
  
  // Italian keywords detection
  if (/\b(italiano|aggiungere|correggere|aggiornare|migliorare|modifica)\b/.test(cleanText)) {
    return 'it'
  }
  
  // Dutch keywords detection
  if (/\b(nederlands|toevoegen|corrigeren|bijwerken|verbeteren|wijziging)\b/.test(cleanText)) {
    return 'nl'
  }
  
  // Arabic detection
  if (/[\u0600-\u06ff]/.test(text)) {
    return 'ar'
  }
  
  // Default to English
  return 'en'
}

export function detectLanguageFromPR(prInfo: PRInfo): SupportedLanguage {
  const textToAnalyze = [
    prInfo.title,
    prInfo.body || '',
  ].join(' ')
  
  return detectLanguage(textToAnalyze)
}

// Utility function to format comment body with mentions and language support
export function formatCommentWithMention(
  author: string,
  suggestions: string[],
  reasoning: string,
  language?: SupportedLanguage,
  prInfo?: PRInfo
): string {
  // Auto-detect language if not provided
  const detectedLanguage = language || (prInfo ? detectLanguageFromPR(prInfo) : 'en')
  
  const template = getLocalizedTemplate(detectedLanguage)
  
  const suggestionsList = suggestions
    .map((suggestion, index) => `${index + 1}. \`${suggestion}\``)
    .join('\n')

  return `${template.greeting.replace('{author}', author)}

${template.explanation}

${suggestionsList}

${template.reasoningLabel} ${reasoning}

${template.actionPrompt}

---
${template.footer}`
}

// Retry wrapper for GitHub API calls
export async function withRetry<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3,
  delayMs: number = 1000
): Promise<T> {
  let lastError: Error

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await operation()
    } catch (error) {
      lastError = error instanceof Error ? error : new Error(String(error))

      // Don't retry on authentication or permission errors
      if (
        lastError.message.includes('401') ||
        lastError.message.includes('403')
      ) {
        throw lastError
      }

      if (attempt === maxRetries) {
        throw new Error(
          `Operation failed after ${maxRetries} attempts: ${lastError.message}`
        )
      }

      // Exponential backoff
      await new Promise(resolve =>
        setTimeout(resolve, delayMs * Math.pow(2, attempt - 1))
      )
    }
  }

  throw lastError!
}